---
title: "COMP/STAT 112 Final Project"
author: "S Khan and R Liu"
output: 
  html_document:
    theme: readable
    highlight: zenburn
    toc: true
    toc_float: true
    df_print: paged
    code_download: true
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r libraries}
library(tidyverse)         # for graphing and data cleaning
library(lubridate)         # for working with dates
library(remotes)
library(ggthemes)
library(mudata2)
library(waffle)
library(dplyr)
library(tidyr)
library(readr)
library(magrittr)
library(hrbrthemes)
library(fansi)
library(stringi)
library(ggplot2)
library(ggalt)
library(scales)
library(emojifont)  
library(maps)          # for map data
library(ggmap)         # for mapping points on maps
library(sf)            # for working with spatial data
library(gridExtra)
theme_set(theme_minimal())
library(RColorBrewer)  # for color palettes
```

```{r data}

Bachelor_Degree_Majors <- read_csv("Data/Bachelor_Degree_Majors.csv")

degree_income <- read_csv("Data/degrees-that-pay-back.csv")

degrees_over_time <- read_csv("Data/1995_2015.csv")

bachelor <- read_csv('Data/Bachelor_Degree_Majors.csv')

median_income <- read_csv('Data/Median_Income.csv')

pop_est_2019 <- read_csv('Data/nst-est2019-01.csv')

edu_exp <- read_csv('Data/states.csv')
```

## Data 
We get bachelor's majors in each state, age and sex category in 2019, U.S. population and median income in each state in 2019, educational attainment data in 1995, 2005, and 2015, and U.S. educational finances data from the US Census Bureau; For the salary data of each major, the data is collected through a year-long survey by PayScale Inc.


## Bachelor's Degree by Gender and Age Group

```{r,fig.height=5,fig.width=12}
Bachelor_Degree_Majors %>%
  subset(select = -`Age Group`) %>%
  subset(select = -State) %>%
  pivot_longer(-c(Sex, `Bachelor's Degree Holders`),
               names_to = "Degree_Type",
               values_to = "Count",
               values_ptypes = list(num_nests = integer())) %>%
  group_by(Sex, Degree_Type) %>%
  filter(Sex != "Total") %>%
  summarize(num_degree = round(mean(Count)),
            num_total = round(mean(`Bachelor's Degree Holders`))) %>%
  mutate(prop_degree = round(num_degree/num_total*99.8)) %>%
  arrange(desc(prop_degree)) %>%
  mutate(Degree_Type = fct_rev(Degree_Type),
         Degree_Type = fct_reorder(Degree_Type, prop_degree)) %>%
  ggplot(aes(fill = Degree_Type,
             values = prop_degree)) +
  geom_waffle(n_rows = 10, 
              size = 0.1,
              color = "midnightblue") +
  facet_wrap(~Sex) +
  coord_equal() +
  theme_ipsum_rc(grid = "") +
  theme_enhance_waffle() +
  theme_igray() +
  scale_fill_manual(
    name = NULL,
    values = c("cornflowerblue", "palevioletred4", "goldenrod1", "tan2", 
               "slateblue4")) +
  labs(title = "Distribution of Bachelor's Degrees by Gender", 
       subtitle = "",
       fill = "") +
  theme(legend.position = "bottom",
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        legend.text = element_text(size = 13.5),
        plot.title = element_text(hjust = 0.5,
                                  size = 35,
                                  margin = margin(10,0,0,0)),
        strip.text = element_text(size = 30)) +
  guides(fill = guide_legend(reverse = TRUE),
         fill = guide_legend(override.aes = list(size = 1)))
```

```{r,fig.height=5,fig.width=12}
Bachelor_Degree_Majors %>%
  subset(select = -Sex) %>%
  subset(select = -State) %>%
  pivot_longer(-c(`Age Group`, `Bachelor's Degree Holders`),
               names_to = "Degree_Type",
               values_to = "Count",
               values_ptypes = list(num_nests = integer())) %>%
  group_by(`Age Group`, Degree_Type) %>%
  filter(`Age Group` != "25 and older") %>%
  summarize(num_degree = round(mean(Count)),
            num_total = round(mean(`Bachelor's Degree Holders`))) %>%
  mutate(prop_degree = num_degree/num_total*102.2) %>%
  arrange(desc(prop_degree)) %>%
   mutate(Degree_Type = fct_rev(Degree_Type),
         Degree_Type = fct_reorder(Degree_Type, prop_degree)) %>%
  ggplot(aes(fill = Degree_Type,
             values = prop_degree)) +
  geom_waffle(n_rows = 10, 
              size = 0.1,
              color = "midnightblue") +
  facet_wrap(~`Age Group`) +
  coord_equal() +
  theme_ipsum_rc(grid = "") +
  theme_enhance_waffle() +
  theme_igray() +
  scale_fill_manual(
    name = NULL,
    values = c("palevioletred4", "cornflowerblue", "goldenrod1", "tan2", 
               "slateblue4")) +
  labs(title = "Distribution of Bachelor's Degrees by Age Group", 
       subtitle = "",
       fill = "") +
  theme(legend.position = "bottom",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 21),
        plot.title = element_text(hjust = 0.5,
                                  size = 35,
                                  margin = margin(10,0,0,0)),
        strip.text = element_text(size = 30)) +
  guides(fill = guide_legend(reverse = TRUE),
         fill = guide_legend(override.aes = list(size = 1)))
```

## Bachelor's Degrees Over Time

```{r}
degrees_over_time %>%
#  subset(select = -c(No_HS_Diploma, HS_Diploma, Some_College_No_Degree, Associate, 
#                     Advanced)) %>%
  group_by(Year) %>%
  subset(select = -Total) %>%
  summarize(`No HS Diploma` = No_HS_Diploma,
         `HS Diploma` = HS_Diploma,
         `Some College No Degree` = Some_College_No_Degree,
         Associate = Associate, Advanced = Advanced,
         Bachelor = Bachelor) %>%
  pivot_longer(-c(Year),
               names_to = "Degree_Type",
               values_to = "Count",
               values_ptypes = list(num_nests = integer())) %>%
  group_by(Year, Degree_Type) %>%
  summarize(Count = round(mean(Count))) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x = Year,
             y = Count,
             fill = Degree_Type)) +
  geom_col(width = 4.5) +
  labs(title = "Attainment of Education Over Time in the US", 
       subtitle = "Number of degrees reported in the US from 1995-2015",
       fill = "") +
  theme_igray() +
  #scale_fill_manual(
    #name = NULL,
    #values = c("darkslateblue", "steelblue4", "tan2", "lightblue4", "azure4", 
              #"darkgrey")) +
  scale_fill_brewer(palette="Blues") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 18),
        axis.title = element_blank(),
        axis.text = element_text(size = 18),
        plot.title = element_text(hjust = 0.5,
                                  size = 25,
                                  margin = margin(10,0,0,0)),
        plot.subtitle = element_text(size = 20,
                                     hjust = 0.5,
                                     margin = margin(5,0,15,0),
                                     color = "grey22",
                                     face = "italic"))
```

## Bachelor's Degrees Income

```{r,fig.height=5,fig.width=8}
degree_income_exp <- degree_income %>%
  mutate(perc_change = `Percent change from Starting to Mid-Career Salary`,
         major = `Undergraduate Major`,
         Starting = `Starting Median Salary`,
         `Mid-Career` = `Mid-Career Median Salary`)

degree_income_starting <- degree_income_exp %>%
  group_by(major) %>%
  summarize(Starting = parse_number(Starting)) %>%
  pivot_wider(names_from = major,
              values_from = Starting) %>%
  mutate(`Science and Engineering` = (`Aerospace Engineering` + 
                                      `Chemical Engineering` + `Civil Engineering` + 
                                      `Electrical Engineering` + 
                                      `Computer Engineering` + 
                                      `Industrial Engineering` + 
                                      `Mechanical Engineering` + Biology + 
                                      Chemistry + Physics + Geology + Sociology + 
                                      Psychology)/13,
         `Science and Engineering Related Fields` = (Agriculture + Architecture + 
                                                    `Computer Science` + 
                                                    Construction + Forestry + 
                                                    Geography + 
                                                    `Information Technology (IT)` + 
                                                    Math + Nursing + Nutrition + 
                                                    `Physician Assistant`)/11,
         Business = (Accounting + `Business Management` + Communications + 
                     Economics + Finance + `Hospitality & Tourism` + 
                     `International Relations` + 
                     `Management Information Systems (MIS)` + Marketing + 
                     `Health Care Administration`)/10,
         Education = Education,
         `Arts, Humanities, and Others` = (Anthropology + `Art History` + 
                                           `Criminal Justice` + Drama + English + 
                                           Film + `Graphic Design` + History + 
                                           `Interior Design` + Journalism + Music + 
                                           Philosophy + `Political Science` + 
                                           Religion + Spanish)/15,
         .keep = "unused") %>%
  pivot_longer(cols = everything(),
               names_to = "Major",
               values_to = "Starting")

degree_income_mid <- degree_income_exp %>%
  group_by(major) %>%
  summarize(`Mid-Career` = parse_number(`Mid-Career`)) %>%
  pivot_wider(names_from = major,
              values_from = `Mid-Career`) %>%
  mutate(`Science and Engineering` = (`Aerospace Engineering` + 
                                      `Chemical Engineering` + `Civil Engineering` + 
                                      `Electrical Engineering` + 
                                      `Computer Engineering` + 
                                      `Industrial Engineering` + 
                                      `Mechanical Engineering` + Biology + 
                                      Chemistry + Physics + Geology + Sociology + 
                                      Psychology)/13,
         `Science and Engineering Related Fields` = (Agriculture + Architecture + 
                                                    `Computer Science` + 
                                                    Construction + Forestry + 
                                                    Geography + 
                                                    `Information Technology (IT)` + 
                                                    Math + Nursing + Nutrition + 
                                                    `Physician Assistant`)/11,
         Business = (Accounting + `Business Management` + Communications + 
                     Economics + Finance + `Hospitality & Tourism` + 
                     `International Relations` + 
                     `Management Information Systems (MIS)` + Marketing + 
                     `Health Care Administration`)/10,
         Education = Education,
         `Arts, Humanities, and Others` = (Anthropology + `Art History` + 
                                           `Criminal Justice` + Drama + English + 
                                           Film + `Graphic Design` + History + 
                                           `Interior Design` + Journalism + Music + 
                                           Philosophy + `Political Science` + 
                                           Religion + Spanish)/15,
         .keep = "unused") %>%
  pivot_longer(cols = everything(),
               names_to = "Major",
               values_to = "Mid-Career")

degree_income_starting %>%
  left_join(degree_income_mid,
            by = "Major") %>%
  pivot_longer(-Major,
               names_to = "type_salary",
               values_to = "salary") %>%
  arrange(desc(salary)) %>%
  ggplot(aes(x = salary,
             y = Major,
             color = type_salary)) + 
  geom_point(size = 3) + 
  geom_segment(aes(x = 0, 
                   xend = salary, 
                   y = Major, 
                   yend = Major)) +
  labs(title = "Distribution of Median Income by Undergraduate Degree", 
       subtitle = "",
       fill = "") +
  theme_igray() +
  scale_color_manual(
    name = NULL,
    values = c("tomato", "dodgerblue")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 20),
        axis.title = element_blank(),
        axis.text = element_text(size = 18),
        plot.title = element_text(hjust = 0,
                                  size = 25,
                                  margin = margin(10,0,0,0))) +
  guides(color = guide_legend(reverse = TRUE))
```

## State bachelor degrees vs.median income

```{r}
pop_est_2019 <- pop_est_2019 %>% 
  mutate(State = str_replace(State,'.','')) %>% 
  rename('total_pop' = '2019')
  
```
```{r,fig.height=5,fig.width=13}
states_map <- map_data("state")

p1<-bachelor %>% 
  filter(Sex == 'Total',
         `Age Group`== '25 and older') %>% 
  group_by(State) %>% 
  summarise(total_bachelor = sum(`Bachelor's Degree Holders`)) %>% 
  merge(pop_est_2019, on = 'State') %>% 
  mutate(bachelor_prop = total_bachelor/total_pop,
         State = str_to_lower(State)) %>% 
  ggplot() +
  geom_map(map = states_map,
           aes(map_id = State,
               fill = bachelor_prop)) +
  expand_limits(x = states_map$long, y = states_map$lat) + 
  theme_map() + 
  labs(title = 'Rate of Bachelor Degree by State',
       fill = 'bachelor degree rate') + 
  scale_fill_gradientn(colours=brewer.pal(7,"Blues"))
  

p2<-median_income %>% 
  mutate(State = str_to_lower(State),
         Income = str_sub(Income,start = 2),
         Income = str_remove(Income,','),
         Income = as.numeric(Income)) %>% 
  ggplot() +
  geom_map(map = states_map,
           aes(map_id = State,
               fill = Income))+
  expand_limits(x = states_map$long, y = states_map$lat) + 
  theme_map() + 
  labs(title = 'Median Income by State',
       fill = 'median income') + 
  scale_fill_gradientn(colours=brewer.pal(7,"Blues"))

grid.arrange(p1,p2,ncol = 2)
```


Would income generally relate with the number of bachelor degrees? The graphs above show the proportion of bachelor degrees in each state and median income of each state respectively. The lighter the state is, the more bachelor degrees that the state has and the higher the median income is. By comparing these two graphs, we could roughly see that in general, the state with higher median income would also has more bachelor degrees. 


## Government expenditure vs Bachelor degree
```{r}
edu<-edu_exp %>% 
  filter(YEAR >=2012) %>% 
  mutate(net_edu_exp = (TOTAL_REVENUE - TOTAL_EXPENDITURE)/ENROLL )%>% 
  group_by(STATE) %>% 
  summarise(net_edu_exp_avg = mean(net_edu_exp)) %>% 
  left_join(
    (bachelor %>% 
  filter(Sex == 'Total',`Age Group`=='25 and older') %>% 
  group_by(State) %>% 
  summarise(total_bachelor = sum(`Bachelor's Degree Holders`)) %>% 
  merge(pop_est_2019, on = 'State') %>% 
  mutate(bachelor_prop = total_bachelor/total_pop)), by = c('STATE' = 'State') ) %>% 
  inner_join(
    (median_income %>% 
  mutate(Income = str_sub(Income,start = 2),
         Income = str_remove(Income,','),
         Income = as.numeric(Income))), by = c('STATE' = 'State')) %>% 
  mutate(IncomeGroup = ifelse(Income > 70000,'Median Income>70000','Median Income<70000'))
```
```{r}

edu%>% 
  ggplot(aes(x = net_edu_exp_avg , y = bachelor_prop)) + 
  geom_point(aes(color = Income)) + 
  geom_text(aes(label=ifelse(bachelor_prop>0.3,as.character(STATE),'')),hjust=1.2,vjust=0) + 
  geom_text(aes(label = ifelse(bachelor_prop<0.16,as.character(STATE),'')),hjust=0.5,vjust=1) + 
  geom_text(aes(label = ifelse(net_edu_exp_avg>1,as.character(STATE),'')),hjust=0.5,vjust=1) + 
  geom_smooth(aes(lty = IncomeGroup), method = "lm", se = FALSE) + 
  labs(x = 'Average Net Educational Expenditure in 5 Years',
       y = 'Rate of Bachelor Degrees',
       title = 'Government educational expenditure vs proportion of bachelor degrees\ndifferentiating by state median income  ',
       lty ='Regression Lines',
       color = 'Median Income') + 
  theme_igray() + 
  scale_color_gradientn(colours=brewer.pal(7,"Blues"))+
  scale_fill_brewer(palette = 'Blues')
 
``` 


Also, for states with different median incomes, the government spending on primary and secondary education may contribute differently to the proportion of bachelor degrees a state has. For example, the graph above compares the averaged net government expenditure on primary and secondary schools in 5 years (2012-2016)
with the rate of bachelor's degrees in each state. Points are marked with different colors for different median incomes. The dashed lines are the regression lines for states with higher median income (above 70000) and those with lower median income (equal to or above 70000). Those lines precisely depict the relationship between the variable and the outcome in different groups. It turns out that in general, we could expect a positive relationship between the average government expenditure on education and the proportion of bachelor's degrees. However, this positive correlation seems to be stronger for states with higher median incomes, as the dashed line showing a steeper slope. For states with lower median income, this positive relationship is minimal and even negative. Some states deviate from the general trend though. For example, though the net education spendings for the District of Columbia and Massachusetts are not exceptional, the proportion of bachelor degrees they have are higher than expected. For states like Indiana, West Virginia, and Mississippi, the proportions of bachelor's degrees are surprisingly low compared to their government educational expenditures. 
